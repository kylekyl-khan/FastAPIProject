<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>公司通訊錄</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Task pane 裡會以 iframe 顯示，設計成左右分欄 UI -->
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color-scheme: light;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #f5f5f7;
      }

      header {
        padding: 8px 12px;
        background: #005fb8;
        color: #ffffff;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      header .title {
        font-weight: 600;
      }

      header .env {
        font-size: 11px;
        opacity: 0.8;
      }

      main {
        flex: 1;
        display: flex;
        height: calc(100vh - 40px);
      }

      /* 左側：樹狀結構 + 搜尋 */
      .sidebar {
        width: 40%;
        max-width: 360px;
        min-width: 260px;
        border-right: 1px solid #ddd;
        background: #ffffff;
        display: flex;
        flex-direction: column;
      }

      .search-box {
        padding: 8px;
        border-bottom: 1px solid #eee;
      }

      .search-box input {
        width: 100%;
        padding: 6px 8px;
        font-size: 13px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }

      .tree-container {
        flex: 1;
        overflow: auto;
        padding: 8px;
      }

      ul.tree-root,
      ul.tree-children {
        list-style: none;
        padding-left: 0;
        margin: 0;
      }

      li.tree-node {
        margin: 2px 0;
      }

      .tree-label {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 6px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
      }

      .tree-label:hover {
        background: #f0f4ff;
      }

      .tree-label .badge {
        font-size: 10px;
        padding: 0 4px;
        border-radius: 3px;
        background: #e5f0ff;
        color: #245ea8;
        flex-shrink: 0;
      }

      .tree-label .name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      li.tree-node.employee .tree-label {
        padding-left: 14px;
      }

      li.tree-node.employee.selected .tree-label {
        background: #e3f2fd;
        outline: 1px solid #90caf9;
      }

      li.collapsed > ul.tree-children {
        display: none;
      }

      /* 右側：詳細資訊 */
      .detail-pane {
        flex: 1;
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .detail-card {
        background: #ffffff;
        border-radius: 6px;
        padding: 10px 12px;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        font-size: 13px;
      }

      .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .detail-name {
        font-size: 15px;
        font-weight: 600;
      }

      .detail-title {
        font-size: 12px;
        color: #555;
      }

      .detail-meta,
      .detail-contact {
        display: grid;
        grid-template-columns: minmax(80px, 120px) 1fr;
        row-gap: 4px;
        column-gap: 8px;
      }

      .detail-label {
        color: #777;
        font-size: 12px;
      }

      .detail-value {
        font-size: 13px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        padding: 2px 6px;
        border-radius: 999px;
        background: #f3f4f6;
        font-size: 11px;
        color: #555;
      }

      .hint {
        font-size: 12px;
        color: #777;
      }

      .empty-state {
        font-size: 13px;
        color: #666;
        text-align: center;
        margin-top: 40px;
      }

      .section-title {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
        color: #444;
      }

      .btn-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
      }

      button {
        border: none;
        border-radius: 4px;
        font-size: 12px;
        padding: 4px 8px;
        cursor: pointer;
        background: #005fb8;
        color: #fff;
      }

      button.secondary {
        background: #e5e7eb;
        color: #111827;
      }

      button:disabled {
        opacity: 0.5;
        cursor: default;
      }

      @media (max-width: 800px) {
        main {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          max-width: none;
          min-width: 0;
          height: 45%;
        }

        .detail-pane {
          height: 55%;
          border-top: 1px solid #ddd;
        }
      }
    </style>
  </head>

  <body>
    <header>
      <div class="title">公司通訊錄</div>
      <div class="env">本機開發環境 · 連線至 FastAPI /contacts</div>
    </header>

    <main>
      <!-- 左側：樹 + 搜尋 -->
      <section class="sidebar">
        <div class="search-box">
          <input
            id="searchInput"
            type="text"
            placeholder="搜尋姓名或部門關鍵字..."
          />
        </div>
        <div class="tree-container">
          <ul id="treeRoot" class="tree-root"></ul>
        </div>
      </section>

      <!-- 右側：詳細資訊 -->
      <section class="detail-pane">
        <div id="emptyState" class="empty-state">
          請從左側樹狀清單中選擇一位員工，即可在此查看詳細資訊。
        </div>

        <div id="detailCard" class="detail-card" style="display: none">
          <div class="detail-header">
            <div>
              <div id="detailName" class="detail-name"></div>
              <div id="detailTitle" class="detail-title"></div>
            </div>
            <div id="detailStatus" class="pill"></div>
          </div>

          <div class="section">
            <div class="section-title">基本資訊</div>
            <div class="detail-meta">
              <div class="detail-label">公司</div>
              <div id="detailCompany" class="detail-value"></div>

              <div class="detail-label">校區 / 單位</div>
              <div id="detailCampus" class="detail-value"></div>

              <div class="detail-label">部門</div>
              <div id="detailDeptName" class="detail-value"></div>

              <div class="detail-label">職稱</div>
              <div id="detailJob" class="detail-value"></div>

              <div class="detail-label">員工編號</div>
              <div id="detailEmployeeId" class="detail-value"></div>

              <div class="detail-label">分機</div>
              <div id="detailExt" class="detail-value"></div>
            </div>
          </div>

          <div class="section" style="margin-top: 8px">
            <div class="section-title">聯絡方式（點選員工才會顯示）</div>
            <div class="detail-contact">
              <div class="detail-label">Email</div>
              <div id="detailEmail" class="detail-value"></div>

              <div class="detail-label">辦公室電話</div>
              <div id="detailPhoneNo" class="detail-value"></div>

              <div class="detail-label">手機</div>
              <div id="detailMobile" class="detail-value"></div>
            </div>
            <div class="hint" style="margin-top: 4px">
              出於隱私考量，通訊錄只在選定員工時顯示完整聯絡資訊。
            </div>
          </div>

          <!-- 未來要接 Office.js 的話，可以在這裡加「加入收件人」按鈕 -->
          <div class="section" style="margin-top: 8px">
            <div class="section-title">Outlook 操作</div>
            <div class="btn-row">
              <button id="btnAddTo" disabled>加入收件人 (To)</button>
              <button id="btnAddCc" class="secondary" disabled>
                加入副本 (Cc)
              </button>
            </div>
            <div class="hint">
              目前僅顯示 UI，之後可接上 Office.js 將選定員工加入郵件收件人欄位。
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- 若未來要啟用 Office.js，可取消註解 -->
    <!-- <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script> -->

    <script>
      // ==========
      // 資料模型說明（對應後端 EmployeePublic / TreeNode）
      // ==========
      /**
       * 後端 EmployeePublic JSON 結構（對應 main.py 的 EmployeePublic）：
       * {
       *   "company_id": str,
       *   "employee_id": str,
       *   "name": str,
       *   "ename": str | null,
       *   "email": str | null,
       *   "campus": str | null,
       *   "dept_id": str | null,
       *   "dept_name": str | null,
       *   "title": str | null,
       *   "job": str | null,
       *   "phone_no": str | null,
       *   "mobile_phone": str | null,
       *   "ext": str | null,
       *   "status": str | null
       * }
       *
       * TreeNode 結構（對應 main.py 的 TreeNode）：
       * {
       *   "key": "company:KH" | "campus:xxx" | "dept:xxx:yyy" | "emp:123",
       *   "label": "康軒" / "台北校區" / "資訊部" / "員工姓名",
       *   "node_type": "company" | "campus" | "dept" | "employee",
       *   "children": [TreeNode, ...],
       *   "data": EmployeePublic | null
       * }
       */

      const API_BASE = ""; // 使用相對路徑，避免綁死 host/port

      const state = {
        fullTree: [],
        filteredTree: [],
        selectedEmployeeKey: null,
      };

      const treeRootEl = document.getElementById("treeRoot");
      const searchInputEl = document.getElementById("searchInput");
      const emptyStateEl = document.getElementById("emptyState");
      const detailCardEl = document.getElementById("detailCard");

      const detailNameEl = document.getElementById("detailName");
      const detailTitleEl = document.getElementById("detailTitle");
      const detailStatusEl = document.getElementById("detailStatus");
      const detailCompanyEl = document.getElementById("detailCompany");
      const detailCampusEl = document.getElementById("detailCampus");
      const detailDeptNameEl = document.getElementById("detailDeptName");
      const detailJobEl = document.getElementById("detailJob");
      const detailEmployeeIdEl = document.getElementById("detailEmployeeId");
      const detailExtEl = document.getElementById("detailExt");
      const detailEmailEl = document.getElementById("detailEmail");
      const detailPhoneNoEl = document.getElementById("detailPhoneNo");
      const detailMobileEl = document.getElementById("detailMobile");

      const btnAddTo = document.getElementById("btnAddTo");
      const btnAddCc = document.getElementById("btnAddCc");

      // ==========
      // 初始化：載入樹狀資料
      // ==========
      async function loadContactsTree() {
        try {
          const res = await fetch(`${API_BASE}/contacts/tree`);
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
          }
          const data = await res.json();
          state.fullTree = data || [];
          state.filteredTree = state.fullTree;
          renderTree();
        } catch (err) {
          console.error("載入通訊錄樹狀結構失敗：", err);
          treeRootEl.innerHTML =
            '<li class="tree-node"><div class="tree-label">無法載入通訊錄，請稍後再試。</div></li>';
        }
      }

      // ==========
      // 樹狀 UI render
      // ==========
      function renderTree() {
        treeRootEl.innerHTML = "";
        const ul = document.createElement("ul");
        ul.className = "tree-root";

        const nodes = state.filteredTree || [];
        nodes.forEach((node) => {
          const li = createTreeNodeElement(node);
          ul.appendChild(li);
        });

        treeRootEl.appendChild(ul);
      }

      function createTreeNodeElement(node) {
        const li = document.createElement("li");
        li.classList.add("tree-node", node.node_type);

        const label = document.createElement("div");
        label.className = "tree-label";

        const badge = document.createElement("span");
        badge.className = "badge";

        switch (node.node_type) {
          case "company":
            badge.textContent = "公司";
            break;
          case "campus":
            badge.textContent = "校區";
            break;
          case "dept":
            badge.textContent = "部門";
            break;
          case "employee":
            badge.textContent = "員工";
            break;
          default:
            badge.textContent = node.node_type;
        }

        const nameSpan = document.createElement("span");
        nameSpan.className = "name";

        if (node.node_type === "employee" && node.data) {
          const title = node.data.title || node.data.job || "";
          const dept = node.data.dept_name || "";
          const ext = node.data.ext ? `分機 ${node.data.ext}` : "";
          const parts = [node.data.name, dept, title, ext].filter(Boolean);
          nameSpan.textContent = parts.join(" · ");
        } else {
          nameSpan.textContent = node.label;
        }

        label.appendChild(badge);
        label.appendChild(nameSpan);

        label.addEventListener("click", () => {
          if (node.node_type === "employee" && node.data) {
            state.selectedEmployeeKey = node.key;
            highlightSelectedEmployee();
            showEmployeeDetails(node.data);
          } else {
            li.classList.toggle("collapsed");
          }
        });

        li.appendChild(label);

        if (node.children && node.children.length > 0) {
          const ul = document.createElement("ul");
          ul.className = "tree-children";
          node.children.forEach((child) => {
            const childLi = createTreeNodeElement(child);
            ul.appendChild(childLi);
          });
          li.appendChild(ul);
        }

        return li;
      }

      function highlightSelectedEmployee() {
        const nodeEls = treeRootEl.querySelectorAll("li.tree-node.employee");
        nodeEls.forEach((el) => el.classList.remove("selected"));

        if (!state.selectedEmployeeKey) return;

        const match = Array.from(nodeEls).find((el) =>
          el.textContent.includes("")
        );
        // 這裡我們沒有直接在 DOM 綁 key，若要精準匹配可以之後加 data-key 屬性
      }

      // ==========
      // 詳細資訊顯示
      // ==========
      function showEmployeeDetails(emp) {
        if (!emp) return;

        emptyStateEl.style.display = "none";
        detailCardEl.style.display = "block";

        detailNameEl.textContent = emp.name || "(未填寫姓名)";
        const titleParts = [];
        if (emp.title) titleParts.push(emp.title);
        if (emp.job && emp.job !== emp.title) titleParts.push(emp.job);
        detailTitleEl.textContent = titleParts.join(" · ") || "職稱未設定";

        detailStatusEl.textContent = emp.status || "在職";
        detailCompanyEl.textContent = emp.company_id || "—";
        detailCampusEl.textContent = emp.campus || "—";
        detailDeptNameEl.textContent = emp.dept_name || emp.dept_id || "—";
        detailJobEl.textContent = emp.job || emp.title || "—";
        detailEmployeeIdEl.textContent = emp.employee_id || "—";
        detailExtEl.textContent = emp.ext || "—";

        detailEmailEl.textContent = emp.email || "—";
        detailPhoneNoEl.textContent = emp.phone_no || "—";
        detailMobileEl.textContent = emp.mobile_phone || "—";

        // 目前先只啟用 UI，不接 Office.js
        const hasEmail = !!emp.email;
        btnAddTo.disabled = !hasEmail;
        btnAddCc.disabled = !hasEmail;
      }

      // ==========
      // 搜尋：依姓名/部門關鍵字做簡單 filter
      // ==========
      function filterTree(keyword) {
        if (!keyword) {
          state.filteredTree = state.fullTree;
          renderTree();
          return;
        }

        const lower = keyword.toLowerCase();

        function matchEmployee(emp) {
          if (!emp) return false;
          const fields = [
            emp.name,
            emp.ename,
            emp.dept_name,
            emp.job,
            emp.title,
            emp.campus,
          ]
            .filter(Boolean)
            .join(" ")
            .toLowerCase();
          return fields.includes(lower);
        }

        function filterNode(node) {
          let childrenMatches = [];
          if (Array.isArray(node.children)) {
            childrenMatches = node.children
              .map(filterNode)
              .filter((n) => n !== null);
          }

          const selfMatches =
            node.node_type === "employee" && matchEmployee(node.data);

          if (selfMatches || childrenMatches.length > 0) {
            return {
              ...node,
              children: childrenMatches,
            };
          }

          // 校區/部門名稱本身也可以被搜尋
          const labelText = (node.label || "").toLowerCase();
          if (
            (node.node_type === "campus" || node.node_type === "dept") &&
            labelText.includes(lower)
          ) {
            return {
              ...node,
              children: childrenMatches,
            };
          }

          return null;
        }

        state.filteredTree =
          state.fullTree
            .map(filterNode)
            .filter((n) => n !== null) || [];
        renderTree();
      }

      // ==========
      // 事件綁定
      // ==========
      searchInputEl.addEventListener("input", (e) => {
        const keyword = e.target.value.trim();
        filterTree(keyword);
      });

      // 目前按鈕只做 UI 提示，之後可接 Office.js
      btnAddTo.addEventListener("click", () => {
        alert("未接 Office.js：未來可在此實作『加入收件人 (To)』功能。");
      });

      btnAddCc.addEventListener("click", () => {
        alert("未接 Office.js：未來可在此實作『加入副本 (Cc)』功能。");
      });

      // ==========
      // 啟動
      // ==========
      document.addEventListener("DOMContentLoaded", () => {
        loadContactsTree();
      });
    </script>
  </body>
</html>
