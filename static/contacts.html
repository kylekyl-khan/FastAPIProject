<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>公司通訊錄</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --accent: #0f6cbd;
      --accent-soft: #eef5ff;
      --error: #b42318;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Noto Sans TC", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      padding: 16px 20px 8px;
      border-bottom: 1px solid var(--border);
    }

    header h1 {
      margin: 0;
      font-size: 1.35rem;
    }

    main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 12px 16px 18px;
      max-width: 1080px;
      margin: 0 auto;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    #tree-panel {
      max-height: 520px;
      overflow-y: auto;
    }

    ul.tree {
      list-style: none;
      padding-left: 12px;
      margin: 0;
    }

    ul.tree li {
      margin: 4px 0;
    }

    .node-label {
      cursor: pointer;
      padding: 6px 8px;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease;
    }

    .node-label:hover {
      background: var(--accent-soft);
    }

    .node-label.employee.active {
      background: var(--accent-soft);
      border: 1px solid var(--accent);
    }

    .badge {
      background: var(--accent-soft);
      color: var(--accent);
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 0.85rem;
    }

    #status {
      margin: 8px 16px;
      color: var(--muted);
    }

    #error {
      color: var(--error);
      padding: 10px 12px;
      margin: 0 16px;
      background: #fef3f2;
      border: 1px solid #fecdd3;
      border-radius: 10px;
      display: none;
    }

    #detail-panel h2 {
      margin: 0 0 6px 0;
      font-size: 1.2rem;
    }

    #detail-panel .muted { color: var(--muted); }

    .detail-row {
      margin: 6px 0;
      display: flex;
      gap: 8px;
      word-break: break-all;
    }

    .detail-row strong { width: 72px; }
  </style>
</head>
<body>
  <header>
    <h1>公司通訊錄</h1>
    <div id="status">正在載入資料...</div>
  </header>

  <div id="error"></div>

  <main>
    <section id="tree-panel" class="panel">
      <ul id="tree-root" class="tree"></ul>
    </section>

    <section id="detail-panel" class="panel">
      <p class="muted" id="detail-placeholder">請從左側選擇員工以查看詳細資料。</p>
    </section>
  </main>

  <script>
    // 保留樹狀節點快取，方便依 key 取得員工資料
    const state = {
      employeeMap: new Map(),
      activeKey: null,
    };

    // 建立單一節點的 <li>
    function createNodeElement(node) {
      const li = document.createElement('li');
      const label = document.createElement('div');
      label.textContent = node.label;
      label.className = `node-label ${node.node_type}`;

      if (node.node_type === 'employee') {
        label.dataset.key = node.key;
        label.addEventListener('click', () => {
          highlightEmployee(node.key);
          showEmployeeDetail(node);
        });
        state.employeeMap.set(node.key, node);
      }

      li.appendChild(label);

      if (node.children && node.children.length > 0) {
        const ul = document.createElement('ul');
        ul.className = 'tree';
        node.children.forEach((child) => ul.appendChild(createNodeElement(child)));
        li.appendChild(ul);
      }

      return li;
    }

    // 渲染整棵樹
    function renderTree(data) {
      const root = document.getElementById('tree-root');
      root.innerHTML = '';
      state.employeeMap.clear();

      (data || []).forEach((node) => {
        // 只展示公司節點的子節點
        if (node.node_type === 'company') {
          (node.children || []).forEach((child) => root.appendChild(createNodeElement(child)));
        } else {
          root.appendChild(createNodeElement(node));
        }
      });
    }

    // 高亮當前選取的員工
    function highlightEmployee(key) {
      if (state.activeKey) {
        document.querySelectorAll(`[data-key="${state.activeKey}"]`).forEach((el) => el.classList.remove('active'));
      }
      document.querySelectorAll(`[data-key="${key}"]`).forEach((el) => el.classList.add('active'));
      state.activeKey = key;
    }

    // 顯示員工詳細資訊
    function showEmployeeDetail(node) {
      if (!node || node.node_type !== 'employee') return;
      const data = node.data || {};
      const panel = document.getElementById('detail-panel');
      const placeholder = document.getElementById('detail-placeholder');
      if (placeholder) placeholder.remove();

      const phone = data.phone_no ? `${data.phone_no}${data.ext ? ` #${data.ext}` : ''}` : '-';
      const mobile = data.mobile_phone || '-';
      const dept = data.dept_name || '-';
      const title = data.title || data.job || '-';
      const campus = data.campus || '-';

      panel.innerHTML = `
        <h2>${data.name || node.label}</h2>
        <div class="muted">${[dept !== '-' ? dept : null, title !== '-' ? title : null, campus !== '-' ? campus : null].filter(Boolean).join(' ｜ ') || '-'}</div>
        <div class="detail-row"><strong>部門</strong><span>${dept}</span></div>
        <div class="detail-row"><strong>職稱</strong><span>${title}</span></div>
        <div class="detail-row"><strong>校區/組織</strong><span>${campus}</span></div>
        <div class="detail-row"><strong>Email</strong>${data.email ? `<a href="mailto:${data.email}">${data.email}</a>` : '<span class="muted">無資料</span>'}</div>
        <div class="detail-row"><strong>分機</strong><span>${phone}</span></div>
        <div class="detail-row"><strong>手機</strong><span>${mobile}</span></div>
      `;
    }

    // 顯示錯誤訊息（繁體中文）
    function showError(message, detail) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      if (detail) console.error(detail);
    }

    // 初始化：向後端取得樹狀資料
    async function init() {
      const statusEl = document.getElementById('status');
      statusEl.textContent = '正在向伺服器讀取通訊錄...';
      try {
        const resp = await fetch('/contacts/tree');
        if (!resp.ok) {
          const errText = await resp.text();
          throw new Error(`載入失敗 (${resp.status}): ${errText}`);
        }
        const data = await resp.json();
        renderTree(data);
        statusEl.textContent = '資料載入完成';
      } catch (err) {
        statusEl.textContent = '讀取失敗';
        showError('無法載入通訊錄資料，請稍後再試或聯絡系統管理員。', err);
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
